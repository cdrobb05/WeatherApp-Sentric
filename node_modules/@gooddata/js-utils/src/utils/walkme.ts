// (C) 2007-2018 GoodData Corporation
import { isProductionHostname } from './env';
import { loadScript } from './load-script';

export const GDC_WALKME_HASH = '325ea4b9b547463c991a62bf54090302';
const GDC_WALKME_URL = 'https://cdn.walkme.com/users';

function getEnvironment(walkmeHashFromWhiteLabel: string, environment?: string) {
    if (environment) {
        return environment;
    } else if (walkmeHashFromWhiteLabel === GDC_WALKME_HASH && !isProductionHostname(window.location.hostname)) {
        return 'test';
    }
    return '';
}

export function generateFinalUrl(walkmeHashFromWhiteLabel: string, environment?: string): string {
    const env = getEnvironment(walkmeHashFromWhiteLabel, environment);

    return [
        GDC_WALKME_URL,
        walkmeHashFromWhiteLabel,
        env,
        'walkme_' + walkmeHashFromWhiteLabel + '_https.js'
    ].filter(bit => bit !== '')
        .join('/');
}

export function load(walkmeHash: string, walkMeEnvironment?: string): Promise<any> {
    if (!walkmeHash) { return Promise.resolve(); }

    const url = generateFinalUrl(walkmeHash, walkMeEnvironment);

    (window as any)._walkmeConfig = { smartLoad: true };

    return loadScript(url) // load walkme script
        .catch(() => {
            // tslint:disable-next-line:no-console
            console.log(`Error loading walkme library. Please check the presence of ${url}`);
        });
}
